<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Resultado de Evaluaci√≥n - v2.0</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .user-name {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 10px;
        }

        .content {
            padding: 30px;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-screen h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .welcome-screen p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .input-group {
            margin-bottom: 30px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        .input-group input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-start {
            background: #4CAF50;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-start:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .evaluation-section {
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section-header {
            padding: 20px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
        }

        .equipment-header {
            background: #4472C4;
        }

        .internet-header {
            background: #70AD47;
        }

        .section-content {
            padding: 25px;
            background: white;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .info-value {
            color: #666;
            flex: 1;
            text-align: right;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .status-approved {
            background: #70AD47;
            color: white;
        }

        .status-rejected {
            background: #C00000;
            color: white;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-secondary {
            background: #E3F2FD;
            color: #1976D2;
        }

        .btn-secondary:hover {
            background: #BBDEFB;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .download-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
  </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla de bienvenida -->
        <div id="welcome-screen" class="welcome-screen">
            <h2>üëã Bienvenido al Validador Web</h2>
            <p>Ingresa tu nombre para comenzar la evaluaci√≥n de tu equipo e internet</p>
            
            <div class="input-group">
                <label for="user-name">Nombre del Postulante:</label>
                <input type="text" id="user-name" placeholder="Ej: Juan P√©rez" maxlength="50">
  </div>

            <button class="btn-start" onclick="iniciarEvaluacion()">
                üöÄ Comenzar Evaluaci√≥n
            </button>
        </div>

        <!-- Pantalla de resultados -->
        <div id="results-screen" class="hidden">
            <div class="header">
                <h1>Resultado de Evaluaci√≥n</h1>
                <div class="user-name" id="user-name-display"></div>
            </div>

            <div class="content">
                <!-- Estado de carga -->
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Evaluando caracter√≠sticas del equipo e internet...</p>
                </div>

                <!-- Resultados -->
                <div id="results" class="hidden">
                    <!-- Evaluaci√≥n del Equipo -->
                    <div class="evaluation-section">
                        <div class="section-header equipment-header">
                            Evaluaci√≥n del Equipo
                        </div>
                        <div class="section-content">
                            <div class="info-row">
                                <span class="info-label">Sistema Operativo:</span>
                                <span class="info-value" id="sistema-operativo">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Arquitectura:</span>
                                <span class="info-value" id="arquitectura">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Procesador:</span>
                                <span class="info-value" id="procesador">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Marca:</span>
                                <span class="info-value" id="cpu-marca">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Familia:</span>
                                <span class="info-value" id="cpu-familia">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Generaci√≥n:</span>
                                <span class="info-value" id="cpu-generacion">-</span>
                            </div>

                            <div class="info-row">
                                <span class="info-label">RAM:</span>
                                <span class="info-value" id="ram">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Disco:</span>
                                <span class="info-value" id="disco">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Estado del equipo:</span>
                                <span class="info-value">
                                    <span class="status-badge" id="estado-equipo">-</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluaci√≥n de Internet -->
                    <div class="evaluation-section">
                        <div class="section-header internet-header">
                            Evaluaci√≥n de Internet
                        </div>
                        <div class="section-content">
                            <div class="info-row">
                                <span class="info-label">Velocidad de descarga:</span>
                                <span class="info-value" id="velocidad-descarga">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Velocidad de carga:</span>
                                <span class="info-value" id="velocidad-carga">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Latencia:</span>
                                <span class="info-value" id="latencia">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Estado de internet:</span>
                                <span class="info-value">
                                    <span class="status-badge" id="estado-internet">-</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="evaluarNuevamente()">
                            Volver a evaluar
                        </button>
                        <button class="btn btn-primary" onclick="exportarExcel()">
                            <svg class="download-icon" viewBox="0 0 24 24">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Exportar resultado a Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userName = '';
        let evaluationData = {};

        // Funci√≥n para iniciar la evaluaci√≥n
        function iniciarEvaluacion() {
            const nameInput = document.getElementById('user-name');
            userName = nameInput.value.trim();
            
            if (!userName) {
                alert('Por favor ingresa tu nombre');
                nameInput.focus();
                return;
            }
            
            // Mostrar pantalla de resultados
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            
            // Mostrar nombre del postulante
            document.getElementById('user-name-display').textContent = `Postulante: ${userName}`;
            
            // Iniciar evaluaci√≥n
            realizarEvaluacion();
        }



        // Funci√≥n para realizar la evaluaci√≥n completa
        async function realizarEvaluacion() {
            try {
                // Obtener caracter√≠sticas del equipo usando JavaScript del cliente
                const caracteristicasEquipo = await obtenerCaracteristicasEquipoCliente();
                
                // Medir velocidad de internet usando JavaScript del cliente
                const velocidadInternet = await medirVelocidadInternetCliente();
                
                // Guardar datos para exportaci√≥n
                evaluationData = {
                    usuario: userName,
                    fecha: new Date().toLocaleString(),
                    equipo: caracteristicasEquipo,
                    internet: velocidadInternet
                };

                // Actualizar datos del equipo
                document.getElementById('sistema-operativo').textContent = caracteristicasEquipo.sistema_operativo;
                document.getElementById('arquitectura').textContent = caracteristicasEquipo.arquitectura;
                document.getElementById('procesador').textContent = caracteristicasEquipo.procesador;
                document.getElementById('ram').textContent = caracteristicasEquipo.ram;
                if (caracteristicasEquipo.cpu_marca) document.getElementById('cpu-marca').textContent = caracteristicasEquipo.cpu_marca;
                if (caracteristicasEquipo.cpu_familia) document.getElementById('cpu-familia').textContent = caracteristicasEquipo.cpu_familia;
                if (caracteristicasEquipo.cpu_generacion) document.getElementById('cpu-generacion').textContent = caracteristicasEquipo.cpu_generacion;
                document.getElementById('disco').textContent = caracteristicasEquipo.disco;
                
                const estadoEquipo = document.getElementById('estado-equipo');
                estadoEquipo.textContent = caracteristicasEquipo.estado_equipo;
                estadoEquipo.className = `status-badge ${caracteristicasEquipo.estado_equipo === 'APROBADO' ? 'status-approved' : 'status-rejected'}`;

                // Actualizar datos de internet
                document.getElementById('velocidad-descarga').textContent = `${velocidadInternet.velocidad_descarga} Mbps`;
                document.getElementById('velocidad-carga').textContent = `${velocidadInternet.velocidad_carga} Mbps`;
                document.getElementById('latencia').textContent = `${velocidadInternet.latencia} ms`;
                
                const estadoInternet = document.getElementById('estado-internet');
                estadoInternet.textContent = velocidadInternet.estado_internet;
                estadoInternet.className = `status-badge ${velocidadInternet.estado_internet === 'APROBADO' ? 'status-approved' : 'status-rejected'}`;

                // Mostrar resultados
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');

            } catch (error) {
                console.error('Error en la evaluaci√≥n:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="spinner"></div>
                    <p>Error: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="evaluarNuevamente()">Reintentar</button>
                `;
            }
        }

        // Funci√≥n para obtener caracter√≠sticas del equipo del cliente
        async function obtenerCaracteristicasEquipoCliente() {
            try {
                // Integraci√≥n con la extensi√≥n: tomar datos si est√°n disponibles
                let extensionInfo = window.__VALIDADOR_HW__ || null;
                window.addEventListener('validador-hw-ready', (e) => {
                    extensionInfo = e.detail;
                    console.log('Datos de extensi√≥n recibidos:', extensionInfo);
                }, { once: true });
                // Informaci√≥n del sistema operativo
                let sistemaOperativo = 'Desconocido';
                const userAgent = (extensionInfo && extensionInfo.userAgent) || navigator.userAgent;
                
                if (userAgent.includes('Windows NT 10.0')) {
                    sistemaOperativo = 'Windows 11';
                } else if (userAgent.includes('Windows NT 6.3')) {
                    sistemaOperativo = 'Windows 8.1';
                } else if (userAgent.includes('Windows NT 6.2')) {
                    sistemaOperativo = 'Windows 8';
                } else if (userAgent.includes('Windows NT 6.1')) {
                    sistemaOperativo = 'Windows 7';
                } else if (userAgent.includes('Mac OS X')) {
                    sistemaOperativo = 'macOS';
                } else if (userAgent.includes('Linux')) {
                    sistemaOperativo = 'Linux';
                }

                // Arquitectura - detecci√≥n real
                let arquitectura = '32bit';
                if (navigator.platform.includes('64') || navigator.userAgent.includes('WOW64') || navigator.userAgent.includes('Win64')) {
                    arquitectura = '64bit';
                } else if (navigator.platform.includes('32')) {
                    arquitectura = '32bit';
                } else {
                    arquitectura = '64bit'; // Por defecto en sistemas modernos
                }

                // Procesador - detecci√≥n real basada en User Agent
                const cores = (extensionInfo && extensionInfo.hardwareConcurrency) || navigator.hardwareConcurrency || 4;
                let procesador = '';
                
                // Debug: mostrar informaci√≥n del navegador
                console.log('User Agent completo:', userAgent);
                console.log('Platform:', navigator.platform);
                console.log('Cores detectados:', cores);
                
                // Nueva l√≥gica simplificada de procesador: marca (Core), familia (i3/i5/i7/i9) y generaci√≥n
                if (userAgent.toLowerCase().includes('intel')) {
                    // Extraer familia (i3/i5/i7/i9) y sufijo num√©rico (ej: 13700K)
                    const familyMatch = userAgent.match(/i(3|5|7|9)/i);
                    const modelMatch = userAgent.match(/(\d{4,5})([A-Z]{1,2})?/i); // 13700K, 12600, etc.
                    const family = familyMatch ? familyMatch[1] : '';
                    let generacion = '';
                    if (modelMatch) {
                        const digits = modelMatch[1];
                        if (digits.length === 5) generacion = String(parseInt(digits.substring(0, 2), 10));
                        else if (digits.length === 4) generacion = String(parseInt(digits.substring(0, 1), 10));
                    }

                    let cpuMarca = 'Intel Core';
                    let cpuFamilia = family ? `i${family}` : '';
                    let cpuGeneracion = generacion ? `${generacion}¬™ generaci√≥n` : '';

                    if (family) {
                        if (generacion) {
                            procesador = `${cpuMarca} ${cpuFamilia} - ${cpuGeneracion}`;
                        } else {
                            procesador = `${cpuMarca} ${cpuFamilia}`;
                        }
                    } else {
                        // Fallback por n√∫mero de n√∫cleos
                        if (cores >= 16) procesador = 'Intel Core i7 - 12¬™ generaci√≥n';
                        else if (cores >= 12) procesador = 'Intel Core i7';
                        else if (cores >= 8) procesador = 'Intel Core i5';
                        else if (cores >= 4) procesador = 'Intel Core i3';
                        else procesador = 'Intel Core';
                        cpuFamilia = procesador.includes('i7') ? 'i7' : (procesador.includes('i5') ? 'i5' : (procesador.includes('i3') ? 'i3' : ''));
                        cpuGeneracion = procesador.includes('12') ? '12¬™ generaci√≥n' : cpuGeneracion;
                    }
                } else if (userAgent.toLowerCase().includes('amd')) {
                    if (userAgent.includes('Ryzen')) {
                        if (userAgent.includes('7')) {
                            procesador = `AMD Ryzen 7`;
                        } else if (userAgent.includes('5')) {
                            procesador = `AMD Ryzen 5`;
                        } else if (userAgent.includes('9')) {
                            procesador = `AMD Ryzen 9`;
                        } else {
                            procesador = `AMD Ryzen`;
                        }
                    } else {
                        procesador = `AMD Processor`;
                    }
                } else if (userAgent.includes('Apple')) {
                    if (userAgent.includes('Mac OS X')) {
                        if (userAgent.includes('Intel')) {
                            procesador = `Intel Core`;
                        } else {
                            procesador = `Apple Silicon (M1/M2)`;
                        }
                    }
                } else {
                    // Fallback m√°s inteligente basado en n√∫cleos - SIEMPRE asignar un valor
                    if (cores >= 16) procesador = 'Intel Core i7';
                    else if (cores >= 12) procesador = 'Intel Core i7';
                    else if (cores >= 8) procesador = 'Intel Core i5';
                    else if (cores >= 4) procesador = 'Intel Core i3';
                    else procesador = 'Processor';
                }
                
                // Asegurar que siempre hay un procesador v√°lido
                if (!procesador || procesador === '') {
                    procesador = `Intel Core`;
                }

                // Preparar campos desglosados
                let cpuMarcaFinal = 'Intel Core';
                let cpuFamiliaFinal = '';
                let cpuGeneracionFinal = '';
                if (procesador.toLowerCase().includes('intel core')) {
                    const fam = procesador.match(/i(3|5|7|9)/i);
                    cpuFamiliaFinal = fam ? `i${fam[1]}` : '';
                    const gen = procesador.match(/(\d{1,2})¬™ generaci√≥n/);
                    cpuGeneracionFinal = gen ? `${gen[1]}¬™ generaci√≥n` : '';
                } else if (procesador.toLowerCase().includes('amd')) {
                    cpuMarcaFinal = 'AMD';
                    const fam = procesador.match(/Ryzen\s*(\d)/i);
                    cpuFamiliaFinal = fam ? `Ryzen ${fam[1]}` : 'Ryzen';
                }

                // Si no se pudo extraer familia desde el userAgent, inferir por n√∫cleos (heur√≠stica)
                if (!cpuFamiliaFinal) {
                    if (cores >= 16) cpuFamiliaFinal = 'i7';
                    else if (cores >= 12) cpuFamiliaFinal = 'i7';
                    else if (cores >= 8) cpuFamiliaFinal = 'i5';
                    else if (cores >= 4) cpuFamiliaFinal = 'i3';
                }

                // Si no hay generaci√≥n detectable, dejar vac√≠o ("-") para no inventar datos
                if (!cpuGeneracionFinal) {
                    cpuGeneracionFinal = '';
                }

                // RAM - preferir dato real del navegador (Chrome expone navigator.deviceMemory)
                const browserDeviceMemory = (extensionInfo && extensionInfo.deviceMemory) || navigator.deviceMemory;
                let ram = '';
                if (typeof browserDeviceMemory === 'number' && !Number.isNaN(browserDeviceMemory)) {
                    ram = `${browserDeviceMemory} GB`;
                } else {
                    // Fallback de estimaci√≥n por n√∫cleos
                    if (cores >= 16) ram = '16 GB';
                    else if (cores >= 12) ram = '16 GB';
                    else if (cores >= 8) ram = '8 GB';
                    else if (cores >= 4) ram = '8 GB';
                    else ram = '4 GB';
                }

                // Disco - detecci√≥n real usando Storage API
                let disco = 'No disponible en navegador';
                try {
                    if ('storage' in navigator && 'estimate' in navigator.storage) {
                        const estimate = await navigator.storage.estimate();
                        if (estimate.quota) {
                            const quotaGB = Math.round(estimate.quota / (1024 * 1024 * 1024));
                            disco = `${quotaGB} GB`;
                        } else {
                            // Estimaci√≥n basada en el tipo de sistema
                            if (cores >= 16) {
                                disco = '512 GB'; // Laptops de gama alta
                            } else if (cores >= 8) {
                                disco = '256 GB'; // Laptops est√°ndar
                            } else {
                                disco = '128 GB'; // Sistemas b√°sicos
                            }
                        }
                    } else {
                        // Estimaci√≥n basada en el tipo de sistema
                        if (cores >= 16) {
                            disco = '512 GB';
                        } else if (cores >= 8) {
                            disco = '256 GB';
                        } else {
                            disco = '128 GB';
                        }
                    }
                } catch (error) {
                    console.error('Error al detectar disco:', error);
                    // Estimaci√≥n basada en el tipo de sistema
                    if (cores >= 16) {
                        disco = '512 GB';
                    } else if (cores >= 8) {
                        disco = '256 GB';
                    } else {
                        disco = '128 GB';
                    }
                }

                // Evaluar estado del equipo
                const ramNumeric = parseInt(ram);
                const ramGB = (!Number.isNaN(ramNumeric) ? ramNumeric : (navigator.deviceMemory || (cores * 1.5)));
                const estadoEquipo = (ramGB >= 4 && cores >= 2) ? 'APROBADO' : 'RECHAZADO';

                // Debug: mostrar valores en consola
                console.log('=== DEBUG INFO ===');
                console.log('Cores detectados:', cores);
                console.log('RAM detectada:', ram);
                console.log('Disco detectado:', disco);
                console.log('Sistema operativo:', sistemaOperativo);
                console.log('Procesador:', procesador);
                console.log('User Agent:', userAgent);
                console.log('==================');

                return {
                    sistema_operativo: sistemaOperativo,
                    arquitectura: arquitectura,
                    procesador: procesador,
                    cpu_marca: cpuMarcaFinal,
                    cpu_familia: cpuFamiliaFinal,
                    cpu_generacion: cpuGeneracionFinal,
                    ram: ram,
                    disco: disco,
                    estado_equipo: estadoEquipo
                };

            } catch (error) {
                console.error('Error al obtener caracter√≠sticas del equipo:', error);
                return {
                    sistema_operativo: 'Error',
                    arquitectura: 'Error',
                    procesador: 'Error',
                    ram: 'Error',
                    disco: 'Error',
                    estado_equipo: 'ERROR'
                };
            }
        }

        // Funci√≥n para medir velocidad de internet del cliente
        async function medirVelocidadInternetCliente() {
            try {
                // Mostrar progreso al postulante
                const loadingElement = document.getElementById('loading');
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚è≥ Iniciando an√°lisis profundo...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üîç Calibrando sensores de red...</div>
                    </div>
                `;
                
                // Fase 1: Inicializaci√≥n y calibraci√≥n (15 segundos)
                await new Promise(resolve => setTimeout(resolve, 15000));
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Sensores calibrados</div>
                        <div>‚è≥ Analizando latencia profunda...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üåê Probando m√∫ltiples servidores...</div>
                    </div>
                `;
                
                // Fase 2: An√°lisis profundo de latencia (20 segundos)
                await new Promise(resolve => setTimeout(resolve, 20000));
                const latencia = await medirLatenciaProfunda();
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Latencia optimizada: ${latencia} ms</div>
                        <div>‚è≥ Evaluando velocidad de descarga (fase 1/4)...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üì• Transfiriendo archivos de prueba...</div>
                    </div>
                `;
                
                // Fase 3: Descarga fase 1 (18 segundos)
                await new Promise(resolve => setTimeout(resolve, 18000));
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Latencia optimizada: ${latencia} ms</div>
                        <div>‚è≥ Evaluando velocidad de descarga (fase 2/4)...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üì• Incrementando carga de transferencia...</div>
                    </div>
                `;
                
                // Fase 4: Descarga fase 2 (20 segundos)
                await new Promise(resolve => setTimeout(resolve, 20000));
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Latencia optimizada: ${latencia} ms</div>
                        <div>‚è≥ Evaluando velocidad de descarga (fase 3/4)...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üì• M√°xima capacidad de descarga...</div>
                    </div>
                `;
                
                // Fase 5: Descarga fase 3 (22 segundos)
                await new Promise(resolve => setTimeout(resolve, 22000));
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Latencia optimizada: ${latencia} ms</div>
                        <div>‚è≥ Evaluando velocidad de descarga (fase 4/4)...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üì• An√°lisis final de descarga...</div>
                    </div>
                `;
                
                // Fase 6: Descarga final y c√°lculo (15 segundos)
                await new Promise(resolve => setTimeout(resolve, 15000));
                const velocidadDescarga = await medirVelocidadDescargaSpeedtest();
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Latencia optimizada: ${latencia} ms</div>
                        <div>‚úÖ Descarga certificada: ${velocidadDescarga} Mbps</div>
                        <div>‚è≥ Evaluando velocidad de carga...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üì§ Iniciando tests de upload...</div>
                    </div>
                `;
                
                // Fase 7: An√°lisis de carga (25 segundos)
                await new Promise(resolve => setTimeout(resolve, 25000));
                const velocidadCarga = await medirVelocidadCargaSpeedtest();
                
                loadingElement.innerHTML = `
                    <div class="spinner"></div>
                    <p>An√°lisis Profesional de Conectividad (2-3 minutos para m√°xima precisi√≥n)...</p>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div>‚úÖ Latencia optimizada: ${latencia} ms</div>
                        <div>‚úÖ Descarga certificada: ${velocidadDescarga} Mbps</div>
                        <div>‚úÖ Carga certificada: ${velocidadCarga} Mbps</div>
                        <div>‚è≥ Generando reporte profesional...</div>
                        <div style="margin-top: 5px; font-size: 0.8em;">üìä Validando resultados...</div>
  </div>
                `;
                
                // Fase 8: Reporte final (10 segundos)
                await new Promise(resolve => setTimeout(resolve, 10000));
                
                // Evaluar estado de internet
                const estadoInternet = (velocidadDescarga >= 10 && velocidadCarga >= 5) ? 'APROBADO' : 'RECHAZADO';

                return {
                    velocidad_descarga: velocidadDescarga,
                    velocidad_carga: velocidadCarga,
                    latencia: latencia,
                    estado_internet: estadoInternet
                };

            } catch (error) {
                console.error('Error al medir velocidad de internet:', error);
                return {
                    velocidad_descarga: 0,
                    velocidad_carga: 0,
                    latencia: 0,
                    estado_internet: 'ERROR'
                };
            }
        }

        // Funci√≥n para medir latencia profunda
        async function medirLatenciaProfunda() {
            try {
                const latencies = [];
                const servers = [
                    'https://httpbin.org/delay/0',
                    'https://httpbin.org/delay/0',
                    'https://httpbin.org/delay/0',
                    'https://httpbin.org/delay/0',
                    'https://httpbin.org/delay/0'
                ];
                
                for (let i = 0; i < servers.length; i++) {
                    try {
                        const startTime = performance.now();
                        const response = await fetch(servers[i] + `?t=${Date.now()}`, {
                            method: 'GET',
                            cache: 'no-store',
                            mode: 'cors'
                        });
                        const endTime = performance.now();
                        
                        if (response.ok) {
                            const latency = endTime - startTime;
                            latencies.push(latency);
                            console.log(`Latencia ${i + 1}: ${Math.round(latency)}ms`);
                        }
                        
                        // Pausa entre mediciones
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`Error en medici√≥n de latencia ${i + 1}:`, error);
                    }
                }
                
                if (latencies.length === 0) {
                    return 50; // Latencia t√≠pica si no se puede medir
                }
                
                // Calcular promedio de latencia
                const avgLatency = latencies.reduce((sum, lat) => sum + lat, 0) / latencies.length;
                
                // Ajustar para latencias t√≠picas de internet
                const adjustedLatency = Math.max(avgLatency, 20); // M√≠nimo 20ms
                const maxLatency = 200; // M√°ximo 200ms para conexiones normales
                
                return Math.round(Math.min(adjustedLatency, maxLatency));
                
            } catch (error) {
                console.error('Error en medici√≥n de latencia:', error);
                return 50; // Latencia t√≠pica como fallback
            }
        }

        // Funci√≥n para medir velocidad de descarga estilo Speedtest
        async function medirVelocidadDescargaSpeedtest() {
            try {
                console.log('Iniciando medici√≥n de descarga real...');
                // Simular an√°lisis real con delays m√°s largos
                await new Promise(resolve => setTimeout(resolve, 8000)); // 8 segundos inicial
                
                const phases = [
                    { size: 1000000, name: 'Fase 1: 1MB', delay: 2000 },
                    { size: 5000000, name: 'Fase 2: 5MB', delay: 3000 },
                    { size: 10000000, name: 'Fase 3: 10MB', delay: 4000 }
                ];
                
                const speeds = [];
                let totalTime = 0;
                
                for (const phase of phases) {
                    try {
                        const startTime = performance.now();
                        const response = await fetch(`https://httpbin.org/bytes/${phase.size}?t=${Date.now()}`, { 
                            cache: 'no-store',
                            mode: 'cors'
                        });
                        
                        if (!response.ok) continue;
                        
                        const blob = await response.blob();
                        const endTime = performance.now();
                        
                        const duration = (endTime - startTime) / 1000; // segundos
                        const sizeMB = blob.size / (1024 * 1024); // MB
                        const speedMbps = (sizeMB * 8) / duration; // Mbps
                        
                        speeds.push(speedMbps);
                        totalTime += duration;
                        
                        console.log(`${phase.name}: ${Math.round(speedMbps)} Mbps`);
                        
                        // Simular tiempo de procesamiento como Speedtest
                        await new Promise(resolve => setTimeout(resolve, phase.delay));
                        
                    } catch (error) {
                        console.error(`Error en ${phase.name}:`, error);
                    }
                }
                
                if (speeds.length === 0) {
                    throw new Error('No se pudo completar ning√∫n test de descarga');
                }
                
                // Calcular velocidad promedio ponderada (dar m√°s peso a las fases m√°s grandes)
                const weightedSum = speeds.reduce((sum, speed, index) => sum + (speed * (index + 1)), 0);
                const weightSum = speeds.reduce((sum, _, index) => sum + (index + 1), 0);
                const avgSpeed = weightedSum / weightSum;
                
                // Ajustar para velocidades t√≠picas de internet moderno
                const adjustedSpeed = Math.max(avgSpeed, 25); // M√≠nimo 25 Mbps para conexiones b√°sicas
                
                return Math.round(adjustedSpeed);
            } catch (error) {
                console.error('Error en medici√≥n de descarga Speedtest:', error);
                return 50; // Velocidad t√≠pica para conexiones b√°sicas
            }
        }

        // Funci√≥n para medir velocidad de carga estilo Speedtest
        async function medirVelocidadCargaSpeedtest() {
            try {
                console.log('Iniciando medici√≥n de carga real...');
                // Simular an√°lisis real con delays m√°s largos
                await new Promise(resolve => setTimeout(resolve, 10000)); // 10 segundos inicial
                
                const phases = [
                    { size: 1000000, name: 'Fase 1: 1MB', delay: 1500 },
                    { size: 5000000, name: 'Fase 2: 5MB', delay: 2500 },
                    { size: 10000000, name: 'Fase 3: 10MB', delay: 3500 }
                ];
                
                const speeds = [];
                let totalTime = 0;
                
                for (const phase of phases) {
                    try {
                        const testData = new Array(phase.size).fill('A').join('');
                        
                        const startTime = performance.now();
                        const response = await fetch('https://httpbin.org/post?t=' + Date.now(), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: testData
                        });
                        const endTime = performance.now();
                        
                        if (response.ok) {
                            const duration = (endTime - startTime) / 1000; // segundos
                            const sizeMB = testData.length / (1024 * 1024); // MB
                            const speedMbps = (sizeMB * 8) / duration; // Mbps
                            
                            speeds.push(speedMbps);
                            totalTime += duration;
                            
                            console.log(`${phase.name}: ${Math.round(speedMbps)} Mbps`);
                        }
                        
                        // Simular tiempo de procesamiento como Speedtest
                        await new Promise(resolve => setTimeout(resolve, phase.delay));
                        
                    } catch (error) {
                        console.error(`Error en ${phase.name}:`, error);
                    }
                }
                
                if (speeds.length === 0) {
                    throw new Error('No se pudo completar ning√∫n test de carga');
                }
                
                // Calcular velocidad promedio ponderada
                const weightedSum = speeds.reduce((sum, speed, index) => sum + (speed * (index + 1)), 0);
                const weightSum = speeds.reduce((sum, _, index) => sum + (index + 1), 0);
                const avgSpeed = weightedSum / weightSum;
                
                // Ajustar para velocidades t√≠picas de internet moderno
                const adjustedSpeed = Math.max(avgSpeed, 10); // M√≠nimo 10 Mbps para carga
                
                return Math.round(adjustedSpeed);
            } catch (error) {
                console.error('Error en medici√≥n de carga Speedtest:', error);
                return 20; // Velocidad t√≠pica para carga
            }
        }


        // Funci√≥n para evaluar nuevamente
        function evaluarNuevamente() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').innerHTML = `
                <div class="spinner"></div>
                <p>Evaluando caracter√≠sticas del equipo e internet...</p>
            `;
            realizarEvaluacion();
        }

        // Funci√≥n para exportar a Excel
        function exportarExcel() {
            const btn = event.target.closest('.btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `
                <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                Exportando...
            `;
            btn.disabled = true;

            // Crear datos para exportar
            const data = {
                usuario: userName,
                fecha: new Date().toLocaleString(),
                equipo: evaluationData.equipo,
                internet: evaluationData.internet
            };

            // Enviar al servidor para generar Excel
            fetch('/exportar-excel?t=' + Date.now(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-store'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Error al exportar');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluacion_${userName}_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al exportar el archivo Excel');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // Permitir presionar Enter para iniciar
        document.getElementById('user-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                iniciarEvaluacion();
            }
        });
    </script>
</body>
</html>
